<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insider Trading Detector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        .priority-critical { background-color: #fee2e2; color: #991b1b; }
        .priority-high { background-color: #fef3c7; color: #92400e; }
        .priority-medium { background-color: #fef9c3; color: #854d0e; }
        .priority-low { background-color: #f3f4f6; color: #374151; }
        .score-high { color: #dc2626; }
        .score-medium { color: #f59e0b; }
        .score-low { color: #10b981; }
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="search" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Insider Trading Detector</h1>
                        <p class="text-sm text-gray-500">Polymarket & Kalshi Analysis</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="scan-status" class="text-sm text-gray-500"></span>
                    <button id="scan-btn" onclick="startScan()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition">
                        <i data-lucide="radar" class="w-4 h-4"></i>
                        <span>Scan Markets</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex space-x-8">
                <button onclick="showTab('overview')" class="tab-btn tab-active px-1 py-4 text-sm font-medium" data-tab="overview">
                    Overview
                </button>
                <button onclick="showTab('accounts')" class="tab-btn px-1 py-4 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="accounts">
                    Suspicious Accounts
                </button>
                <button onclick="showTab('opportunities')" class="tab-btn px-1 py-4 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="opportunities">
                    Opportunities
                </button>
                <button onclick="showTab('alerts')" class="tab-btn px-1 py-4 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="alerts">
                    Alerts
                </button>
                <button onclick="showTab('markets')" class="tab-btn px-1 py-4 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="markets">
                    Markets
                </button>
                <button onclick="showTab('watched')" class="tab-btn px-1 py-4 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="watched">
                    Watched
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Overview Tab -->
        <div id="tab-overview" class="tab-content">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Markets Tracked</p>
                            <p id="stat-markets" class="text-2xl font-bold text-gray-900">-</p>
                        </div>
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="bar-chart-2" class="w-5 h-5 text-blue-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Total Trades</p>
                            <p id="stat-trades" class="text-2xl font-bold text-gray-900">-</p>
                        </div>
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="activity" class="w-5 h-5 text-green-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Accounts Analyzed</p>
                            <p id="stat-accounts" class="text-2xl font-bold text-gray-900">-</p>
                        </div>
                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="users" class="w-5 h-5 text-purple-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Suspicious Accounts</p>
                            <p id="stat-suspicious" class="text-2xl font-bold text-red-600">-</p>
                        </div>
                        <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Active Alerts</p>
                            <p id="stat-alerts" class="text-2xl font-bold text-orange-600">-</p>
                        </div>
                        <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="bell" class="w-5 h-5 text-orange-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Two Column Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Top Suspicious Accounts -->
                <div class="bg-white rounded-lg shadow">
                    <div class="px-4 py-3 border-b flex items-center justify-between">
                        <h2 class="font-semibold text-gray-900">Top Suspicious Accounts</h2>
                        <button onclick="showTab('accounts')" class="text-sm text-blue-600 hover:text-blue-700">View All</button>
                    </div>
                    <div id="top-accounts" class="divide-y">
                        <div class="p-8 text-center text-gray-500">Loading...</div>
                    </div>
                </div>

                <!-- Recent Alerts -->
                <div class="bg-white rounded-lg shadow">
                    <div class="px-4 py-3 border-b flex items-center justify-between">
                        <h2 class="font-semibold text-gray-900">Recent Alerts</h2>
                        <button onclick="showTab('alerts')" class="text-sm text-blue-600 hover:text-blue-700">View All</button>
                    </div>
                    <div id="recent-alerts" class="divide-y">
                        <div class="p-8 text-center text-gray-500">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Trading Opportunities -->
            <div class="mt-6 bg-white rounded-lg shadow">
                <div class="px-4 py-3 border-b flex items-center justify-between">
                    <h2 class="font-semibold text-gray-900">Trading Opportunities</h2>
                    <button onclick="showTab('opportunities')" class="text-sm text-blue-600 hover:text-blue-700">View All</button>
                </div>
                <div id="top-opportunities" class="p-4">
                    <div class="text-center text-gray-500">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Accounts Tab -->
        <div id="tab-accounts" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="px-4 py-3 border-b flex items-center justify-between">
                    <h2 class="font-semibold text-gray-900">Suspicious Accounts</h2>
                    <div class="flex items-center space-x-4">
                        <select id="account-platform" onchange="loadAccounts()" class="text-sm border rounded px-2 py-1">
                            <option value="">All Platforms</option>
                            <option value="polymarket">Polymarket</option>
                            <option value="kalshi">Kalshi</option>
                        </select>
                        <select id="account-min-score" onchange="loadAccounts()" class="text-sm border rounded px-2 py-1">
                            <option value="0">All Scores</option>
                            <option value="0.3">Score > 0.3</option>
                            <option value="0.5" selected>Score > 0.5</option>
                            <option value="0.7">Score > 0.7</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Account</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Platform</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Score</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Win Rate</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">P&L</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Trades</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reasons</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="accounts-table" class="divide-y">
                            <tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Opportunities Tab -->
        <div id="tab-opportunities" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="px-4 py-3 border-b flex items-center justify-between">
                    <h2 class="font-semibold text-gray-900">Trading Opportunities</h2>
                    <div class="flex items-center space-x-4">
                        <select id="opp-platform" onchange="loadOpportunities()" class="text-sm border rounded px-2 py-1">
                            <option value="">All Platforms</option>
                            <option value="polymarket">Polymarket</option>
                            <option value="kalshi">Kalshi</option>
                        </select>
                        <select id="opp-confidence" onchange="loadOpportunities()" class="text-sm border rounded px-2 py-1">
                            <option value="0.3">Confidence > 30%</option>
                            <option value="0.5" selected>Confidence > 50%</option>
                            <option value="0.7">Confidence > 70%</option>
                        </select>
                    </div>
                </div>
                <div id="opportunities-list" class="divide-y">
                    <div class="p-8 text-center text-gray-500">Loading...</div>
                </div>
            </div>
            <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-start space-x-3">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-yellow-600 mt-0.5"></i>
                    <div>
                        <p class="text-sm text-yellow-800 font-medium">Disclaimer</p>
                        <p class="text-sm text-yellow-700">These opportunities are based on detected suspicious activity. Not financial advice. Always do your own research before trading.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Tab -->
        <div id="tab-alerts" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="px-4 py-3 border-b flex items-center justify-between">
                    <h2 class="font-semibold text-gray-900">Alerts</h2>
                    <div class="flex items-center space-x-4">
                        <select id="alert-hours" onchange="loadAlerts()" class="text-sm border rounded px-2 py-1">
                            <option value="6">Last 6 hours</option>
                            <option value="24" selected>Last 24 hours</option>
                            <option value="48">Last 48 hours</option>
                            <option value="168">Last 7 days</option>
                        </select>
                        <select id="alert-priority" onchange="loadAlerts()" class="text-sm border rounded px-2 py-1">
                            <option value="">All Priorities</option>
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
                <div id="alerts-list" class="divide-y">
                    <div class="p-8 text-center text-gray-500">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Markets Tab -->
        <div id="tab-markets" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="px-4 py-3 border-b flex items-center justify-between">
                    <h2 class="font-semibold text-gray-900">Active Markets</h2>
                    <div class="flex items-center space-x-4">
                        <select id="market-platform" onchange="loadMarkets()" class="text-sm border rounded px-2 py-1">
                            <option value="polymarket">Polymarket</option>
                            <option value="kalshi">Kalshi</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Market</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Yes Price</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Volume</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="markets-table" class="divide-y">
                            <tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Watched Tab -->
        <div id="tab-watched" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="px-4 py-3 border-b flex items-center justify-between">
                    <h2 class="font-semibold text-gray-900">Watched Accounts</h2>
                    <button onclick="showAddWatchModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm flex items-center space-x-1">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>Add Account</span>
                    </button>
                </div>
                <div id="watched-list" class="divide-y">
                    <div class="p-8 text-center text-gray-500">Loading...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Account Detail Modal -->
    <div id="account-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="px-6 py-4 border-b flex items-center justify-between">
                <h3 class="text-lg font-semibold">Account Details</h3>
                <button onclick="closeAccountModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="account-modal-content" class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                Loading...
            </div>
        </div>
    </div>

    <!-- Add Watch Modal -->
    <div id="watch-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b flex items-center justify-between">
                <h3 class="text-lg font-semibold">Watch Account</h3>
                <button onclick="closeWatchModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Account ID / Address</label>
                        <input type="text" id="watch-account-id" class="w-full border rounded-lg px-3 py-2" placeholder="0x...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Platform</label>
                        <select id="watch-platform" class="w-full border rounded-lg px-3 py-2">
                            <option value="polymarket">Polymarket</option>
                            <option value="kalshi">Kalshi</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reason (optional)</label>
                        <input type="text" id="watch-reason" class="w-full border rounded-lg px-3 py-2" placeholder="High win rate...">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="closeWatchModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button onclick="addWatchAccount()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Watch</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scan Modal -->
    <div id="scan-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b flex items-center justify-between">
                <h3 class="text-lg font-semibold">Scan Markets</h3>
                <button onclick="closeScanModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Platforms</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="scan-polymarket" checked class="rounded">
                                <span class="ml-2">Polymarket</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="scan-kalshi" class="rounded">
                                <span class="ml-2">Kalshi</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Markets to Scan</label>
                        <select id="scan-limit" class="w-full border rounded-lg px-3 py-2">
                            <option value="25">25 markets (fast)</option>
                            <option value="50" selected>50 markets</option>
                            <option value="100">100 markets</option>
                            <option value="200">200 markets (slow)</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="closeScanModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button onclick="executeScan()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Start Scan</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API base URL
        const API_BASE = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadStats();
            loadOverviewData();
            checkScanStatus();
        });

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('text-gray-500');
            });

            // Show selected tab
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('tab-active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('text-gray-500');

            // Load data for tab
            switch(tabName) {
                case 'accounts': loadAccounts(); break;
                case 'opportunities': loadOpportunities(); break;
                case 'alerts': loadAlerts(); break;
                case 'markets': loadMarkets(); break;
                case 'watched': loadWatched(); break;
            }
        }

        // Load stats
        async function loadStats() {
            try {
                const res = await fetch(API_BASE + '/api/stats');
                const stats = await res.json();
                document.getElementById('stat-markets').textContent = stats.markets.toLocaleString();
                document.getElementById('stat-trades').textContent = stats.trades.toLocaleString();
                document.getElementById('stat-accounts').textContent = stats.accounts.toLocaleString();
                document.getElementById('stat-suspicious').textContent = stats.suspicious_accounts.toLocaleString();
                document.getElementById('stat-alerts').textContent = stats.alerts.toLocaleString();
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        // Load overview data
        async function loadOverviewData() {
            // Top accounts
            try {
                const res = await fetch(API_BASE + '/api/accounts?min_score=0.3&limit=5');
                const accounts = await res.json();
                const container = document.getElementById('top-accounts');

                if (accounts.length === 0) {
                    container.innerHTML = '<div class="p-8 text-center text-gray-500">No suspicious accounts found. Run a scan to analyze markets.</div>';
                } else {
                    container.innerHTML = accounts.map(acc => `
                        <div class="px-4 py-3 hover:bg-gray-50 cursor-pointer" onclick="showAccountDetail('${acc.id}', '${acc.platform}')">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-mono text-sm">${truncateId(acc.id)}</p>
                                    <p class="text-xs text-gray-500">${acc.platform}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-semibold ${getScoreClass(acc.suspicion_score)}">${(acc.suspicion_score * 100).toFixed(0)}%</p>
                                    <p class="text-xs text-gray-500">${(acc.win_rate * 100).toFixed(0)}% win rate</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Failed to load accounts:', e);
            }

            // Recent alerts
            try {
                const res = await fetch(API_BASE + '/api/alerts?hours=24&limit=5');
                const alerts = await res.json();
                const container = document.getElementById('recent-alerts');

                if (alerts.length === 0) {
                    container.innerHTML = '<div class="p-8 text-center text-gray-500">No recent alerts.</div>';
                } else {
                    container.innerHTML = alerts.map(alert => `
                        <div class="px-4 py-3">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2">
                                        <span class="px-2 py-0.5 text-xs font-medium rounded priority-${alert.priority}">${alert.priority.toUpperCase()}</span>
                                        <span class="text-xs text-gray-500">${formatTime(alert.timestamp)}</span>
                                    </div>
                                    <p class="mt-1 text-sm">${alert.market_title || alert.market_id}</p>
                                    <p class="text-xs text-gray-500">${alert.alert_type}</p>
                                </div>
                                ${alert.recommended_position ? `
                                    <div class="text-right">
                                        <span class="px-2 py-1 text-sm font-medium rounded ${alert.recommended_position === 'YES' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${alert.recommended_position}
                                        </span>
                                        <p class="text-xs text-gray-500 mt-1">${(alert.confidence * 100).toFixed(0)}% conf</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Failed to load alerts:', e);
            }

            // Top opportunities
            try {
                const res = await fetch(API_BASE + '/api/opportunities?min_confidence=0.5');
                const opps = await res.json();
                const container = document.getElementById('top-opportunities');

                if (opps.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-4">No trading opportunities found. Run a scan to analyze markets.</div>';
                } else {
                    container.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${opps.slice(0, 6).map(opp => `
                                <div class="border rounded-lg p-4 hover:shadow-md transition">
                                    <div class="flex items-start justify-between mb-2">
                                        <span class="px-2 py-0.5 text-xs font-medium rounded priority-${opp.priority}">${opp.priority}</span>
                                        <span class="text-xs text-gray-500">${opp.platform}</span>
                                    </div>
                                    <p class="font-medium text-sm mb-2 line-clamp-2">${opp.market_title || opp.market_id}</p>
                                    <div class="flex items-center justify-between">
                                        <span class="px-3 py-1 text-sm font-bold rounded ${opp.recommended_position === 'YES' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${opp.recommended_position}
                                        </span>
                                        <div class="text-right">
                                            <p class="text-sm font-semibold">${(opp.confidence * 100).toFixed(0)}%</p>
                                            <p class="text-xs text-gray-500">confidence</p>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2 line-clamp-2">${opp.reasoning}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Failed to load opportunities:', e);
            }
        }

        // Load accounts
        async function loadAccounts() {
            const platform = document.getElementById('account-platform').value;
            const minScore = document.getElementById('account-min-score').value;

            try {
                let url = API_BASE + `/api/accounts?min_score=${minScore}&limit=100`;
                if (platform) url += `&platform=${platform}`;

                const res = await fetch(url);
                const accounts = await res.json();
                const tbody = document.getElementById('accounts-table');

                if (accounts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">No accounts found</td></tr>';
                } else {
                    tbody.innerHTML = accounts.map(acc => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3">
                                <button onclick="showAccountDetail('${acc.id}', '${acc.platform}')" class="font-mono text-sm text-blue-600 hover:underline">
                                    ${truncateId(acc.id)}
                                </button>
                            </td>
                            <td class="px-4 py-3 text-sm">${acc.platform}</td>
                            <td class="px-4 py-3 text-sm text-right font-semibold ${getScoreClass(acc.suspicion_score)}">${(acc.suspicion_score * 100).toFixed(0)}%</td>
                            <td class="px-4 py-3 text-sm text-right">${(acc.win_rate * 100).toFixed(1)}%</td>
                            <td class="px-4 py-3 text-sm text-right ${acc.total_pnl >= 0 ? 'text-green-600' : 'text-red-600'}">$${acc.total_pnl.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                            <td class="px-4 py-3 text-sm text-right">${acc.total_trades}</td>
                            <td class="px-4 py-3 text-sm text-gray-500 max-w-xs truncate">${acc.suspicion_reasons.slice(0, 2).join(', ')}</td>
                            <td class="px-4 py-3 text-center">
                                <button onclick="watchAccount('${acc.id}', '${acc.platform}')" class="text-gray-400 hover:text-blue-600" title="Watch account">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    lucide.createIcons();
                }
            } catch (e) {
                console.error('Failed to load accounts:', e);
            }
        }

        // Load opportunities
        async function loadOpportunities() {
            const platform = document.getElementById('opp-platform').value;
            const confidence = document.getElementById('opp-confidence').value;

            try {
                let url = API_BASE + `/api/opportunities?min_confidence=${confidence}`;
                if (platform) url += `&platform=${platform}`;

                const res = await fetch(url);
                const opps = await res.json();
                const container = document.getElementById('opportunities-list');

                if (opps.length === 0) {
                    container.innerHTML = '<div class="p-8 text-center text-gray-500">No opportunities found with the selected filters.</div>';
                } else {
                    container.innerHTML = opps.map(opp => `
                        <div class="p-4 hover:bg-gray-50 fade-in">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <span class="px-2 py-0.5 text-xs font-medium rounded priority-${opp.priority}">${opp.priority}</span>
                                        <span class="text-xs text-gray-500">${opp.platform}</span>
                                        <span class="text-xs text-gray-500">•</span>
                                        <span class="text-xs text-gray-500">${opp.suspicious_accounts} suspicious accounts</span>
                                    </div>
                                    <p class="font-medium">${opp.market_title || opp.market_id}</p>
                                    <p class="text-sm text-gray-500 mt-1">${opp.reasoning}</p>
                                    <div class="flex items-center space-x-4 mt-2 text-sm text-gray-500">
                                        <span>Current: ${(opp.current_price * 100).toFixed(0)}%</span>
                                        <span>Volume: $${opp.volume.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                                    </div>
                                </div>
                                <div class="ml-4 text-center">
                                    <div class="px-4 py-2 rounded-lg ${opp.recommended_position === 'YES' ? 'bg-green-100' : 'bg-red-100'}">
                                        <p class="text-2xl font-bold ${opp.recommended_position === 'YES' ? 'text-green-800' : 'text-red-800'}">${opp.recommended_position}</p>
                                        <p class="text-sm ${opp.recommended_position === 'YES' ? 'text-green-600' : 'text-red-600'}">${(opp.confidence * 100).toFixed(0)}% confidence</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Failed to load opportunities:', e);
            }
        }

        // Load alerts
        async function loadAlerts() {
            const hours = document.getElementById('alert-hours').value;
            const priority = document.getElementById('alert-priority').value;

            try {
                let url = API_BASE + `/api/alerts?hours=${hours}&limit=100`;
                if (priority) url += `&priority=${priority}`;

                const res = await fetch(url);
                const alerts = await res.json();
                const container = document.getElementById('alerts-list');

                if (alerts.length === 0) {
                    container.innerHTML = '<div class="p-8 text-center text-gray-500">No alerts found.</div>';
                } else {
                    container.innerHTML = alerts.map(alert => `
                        <div class="p-4 hover:bg-gray-50 fade-in">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <span class="px-2 py-0.5 text-xs font-medium rounded priority-${alert.priority}">${alert.priority.toUpperCase()}</span>
                                        <span class="text-xs font-medium text-gray-700">${alert.alert_type}</span>
                                        <span class="text-xs text-gray-500">•</span>
                                        <span class="text-xs text-gray-500">${formatTime(alert.timestamp)}</span>
                                    </div>
                                    <p class="font-medium">${alert.market_title || alert.market_id}</p>
                                    <p class="text-sm text-gray-500 mt-1">${alert.reasoning}</p>
                                    <div class="flex items-center space-x-4 mt-2 text-sm text-gray-500">
                                        <span>${alert.platform}</span>
                                        <span>${alert.suspicious_accounts.length} accounts</span>
                                        <span>$${alert.total_suspicious_volume.toLocaleString(undefined, {maximumFractionDigits: 0})} volume</span>
                                    </div>
                                </div>
                                ${alert.recommended_position ? `
                                    <div class="ml-4 text-center">
                                        <div class="px-3 py-1.5 rounded ${alert.recommended_position === 'YES' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            <p class="font-bold">${alert.recommended_position}</p>
                                            <p class="text-xs">${(alert.confidence * 100).toFixed(0)}%</p>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Failed to load alerts:', e);
            }
        }

        // Load markets
        async function loadMarkets() {
            const platform = document.getElementById('market-platform').value;

            try {
                const res = await fetch(API_BASE + `/api/markets?platform=${platform}&limit=50`);
                const markets = await res.json();
                const tbody = document.getElementById('markets-table');

                if (markets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No markets found</td></tr>';
                } else {
                    tbody.innerHTML = markets.map(m => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3">
                                <a href="${m.url}" target="_blank" class="text-blue-600 hover:underline">${m.title}</a>
                            </td>
                            <td class="px-4 py-3 text-right font-mono">${(m.current_yes_price * 100).toFixed(0)}%</td>
                            <td class="px-4 py-3 text-right">$${m.volume.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                            <td class="px-4 py-3 text-center">
                                <span class="px-2 py-0.5 text-xs rounded ${m.status === 'open' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${m.status}</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <a href="${m.url}" target="_blank" class="text-gray-400 hover:text-blue-600">
                                    <i data-lucide="external-link" class="w-4 h-4 inline"></i>
                                </a>
                            </td>
                        </tr>
                    `).join('');
                    lucide.createIcons();
                }
            } catch (e) {
                console.error('Failed to load markets:', e);
            }
        }

        // Load watched accounts
        async function loadWatched() {
            try {
                const res = await fetch(API_BASE + '/api/watched');
                const accounts = await res.json();
                const container = document.getElementById('watched-list');

                if (accounts.length === 0) {
                    container.innerHTML = '<div class="p-8 text-center text-gray-500">No watched accounts. Add accounts to track their trading activity.</div>';
                } else {
                    container.innerHTML = accounts.map(acc => `
                        <div class="p-4 hover:bg-gray-50 flex items-center justify-between">
                            <div>
                                <button onclick="showAccountDetail('${acc.account_id}', '${acc.platform}')" class="font-mono text-sm text-blue-600 hover:underline">
                                    ${acc.account_id}
                                </button>
                                <p class="text-xs text-gray-500">${acc.platform} ${acc.reason ? '• ' + acc.reason : ''}</p>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Failed to load watched:', e);
            }
        }

        // Show account detail modal
        async function showAccountDetail(accountId, platform) {
            const modal = document.getElementById('account-modal');
            const content = document.getElementById('account-modal-content');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            content.innerHTML = '<div class="text-center py-8">Loading...</div>';

            try {
                const res = await fetch(API_BASE + `/api/accounts/${accountId}?platform=${platform}`);
                const data = await res.json();
                const acc = data.account;
                const trades = data.trades || [];

                content.innerHTML = `
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <h4 class="text-sm font-medium text-gray-500 mb-2">Account Info</h4>
                            <dl class="space-y-2">
                                <div class="flex justify-between">
                                    <dt class="text-gray-500">Address</dt>
                                    <dd class="font-mono text-sm">${truncateId(acc.id, 20)}</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-gray-500">Platform</dt>
                                    <dd>${acc.platform}</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-gray-500">First Seen</dt>
                                    <dd>${acc.first_seen ? formatDate(acc.first_seen) : 'N/A'}</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-gray-500">Last Seen</dt>
                                    <dd>${acc.last_seen ? formatDate(acc.last_seen) : 'N/A'}</dd>
                                </div>
                            </dl>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-500 mb-2">Performance</h4>
                            <dl class="space-y-2">
                                <div class="flex justify-between">
                                    <dt class="text-gray-500">Total P&L</dt>
                                    <dd class="font-semibold ${acc.total_pnl >= 0 ? 'text-green-600' : 'text-red-600'}">$${acc.total_pnl.toLocaleString(undefined, {maximumFractionDigits: 0})}</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-gray-500">Win Rate</dt>
                                    <dd>${(acc.win_rate * 100).toFixed(1)}%</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-gray-500">Total Trades</dt>
                                    <dd>${acc.total_trades}</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-gray-500">Total Volume</dt>
                                    <dd>$${acc.total_volume.toLocaleString(undefined, {maximumFractionDigits: 0})}</dd>
                                </div>
                            </dl>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-gray-500 mb-2">Suspicion Analysis</h4>
                        <div class="flex items-center space-x-4 mb-2">
                            <div class="text-3xl font-bold ${getScoreClass(acc.suspicion_score)}">${(acc.suspicion_score * 100).toFixed(0)}%</div>
                            <div class="text-gray-500">suspicion score</div>
                        </div>
                        <ul class="text-sm text-gray-600 space-y-1">
                            ${acc.suspicion_reasons.map(r => `<li>• ${r}</li>`).join('')}
                        </ul>
                    </div>

                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">Recent Trades</h4>
                        ${trades.length === 0 ? '<p class="text-gray-500">No trade data available</p>' : `
                            <div class="max-h-64 overflow-y-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-1 text-left">Time</th>
                                            <th class="px-2 py-1 text-left">Market</th>
                                            <th class="px-2 py-1 text-center">Side</th>
                                            <th class="px-2 py-1 text-right">Price</th>
                                            <th class="px-2 py-1 text-right">Size</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y">
                                        ${trades.map(t => `
                                            <tr>
                                                <td class="px-2 py-1">${formatTime(t.timestamp)}</td>
                                                <td class="px-2 py-1 font-mono">${truncateId(t.market_id)}</td>
                                                <td class="px-2 py-1 text-center">
                                                    <span class="px-2 py-0.5 rounded text-xs ${t.is_yes ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${t.is_yes ? 'YES' : 'NO'}</span>
                                                </td>
                                                <td class="px-2 py-1 text-right">${(t.price * 100).toFixed(0)}%</td>
                                                <td class="px-2 py-1 text-right">${t.size.toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>

                    <div class="mt-6 pt-4 border-t flex justify-between">
                        <button onclick="watchAccount('${acc.id}', '${acc.platform}')" class="px-4 py-2 border rounded-lg hover:bg-gray-50 flex items-center space-x-2">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                            <span>Watch Account</span>
                        </button>
                        <a href="https://${acc.platform === 'polymarket' ? 'polymarket.com/profile/' : 'kalshi.com/profile/'}${acc.id}" target="_blank"
                           class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center space-x-2">
                            <span>View on ${acc.platform}</span>
                            <i data-lucide="external-link" class="w-4 h-4"></i>
                        </a>
                    </div>
                `;
                lucide.createIcons();
            } catch (e) {
                content.innerHTML = '<div class="text-center py-8 text-red-500">Failed to load account details</div>';
            }
        }

        function closeAccountModal() {
            document.getElementById('account-modal').classList.add('hidden');
            document.getElementById('account-modal').classList.remove('flex');
        }

        // Watch account
        async function watchAccount(accountId, platform) {
            try {
                await fetch(API_BASE + `/api/watch/${accountId}?platform=${platform}`, { method: 'POST' });
                alert('Account added to watch list');
            } catch (e) {
                alert('Failed to watch account');
            }
        }

        // Scan functions
        function startScan() {
            document.getElementById('scan-modal').classList.remove('hidden');
            document.getElementById('scan-modal').classList.add('flex');
        }

        function closeScanModal() {
            document.getElementById('scan-modal').classList.add('hidden');
            document.getElementById('scan-modal').classList.remove('flex');
        }

        async function executeScan() {
            const platforms = [];
            if (document.getElementById('scan-polymarket').checked) platforms.push('polymarket');
            if (document.getElementById('scan-kalshi').checked) platforms.push('kalshi');
            const limit = parseInt(document.getElementById('scan-limit').value);

            closeScanModal();

            try {
                const res = await fetch(API_BASE + '/api/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ platforms, limit })
                });
                const data = await res.json();
                document.getElementById('scan-status').textContent = data.message;
                document.getElementById('scan-btn').disabled = true;
                document.getElementById('scan-btn').classList.add('opacity-50');

                // Poll for completion
                pollScanStatus();
            } catch (e) {
                alert('Failed to start scan');
            }
        }

        async function checkScanStatus() {
            try {
                const res = await fetch(API_BASE + '/api/scan/status');
                const data = await res.json();
                if (data.running) {
                    document.getElementById('scan-status').textContent = 'Scan in progress...';
                    document.getElementById('scan-btn').disabled = true;
                    document.getElementById('scan-btn').classList.add('opacity-50');
                    pollScanStatus();
                }
            } catch (e) {}
        }

        async function pollScanStatus() {
            const interval = setInterval(async () => {
                try {
                    const res = await fetch(API_BASE + '/api/scan/status');
                    const data = await res.json();
                    if (!data.running) {
                        clearInterval(interval);
                        document.getElementById('scan-status').textContent = 'Scan complete!';
                        document.getElementById('scan-btn').disabled = false;
                        document.getElementById('scan-btn').classList.remove('opacity-50');
                        loadStats();
                        loadOverviewData();
                        setTimeout(() => {
                            document.getElementById('scan-status').textContent = '';
                        }, 3000);
                    }
                } catch (e) {
                    clearInterval(interval);
                }
            }, 2000);
        }

        // Watch modal functions
        function showAddWatchModal() {
            document.getElementById('watch-modal').classList.remove('hidden');
            document.getElementById('watch-modal').classList.add('flex');
        }

        function closeWatchModal() {
            document.getElementById('watch-modal').classList.add('hidden');
            document.getElementById('watch-modal').classList.remove('flex');
        }

        async function addWatchAccount() {
            const accountId = document.getElementById('watch-account-id').value;
            const platform = document.getElementById('watch-platform').value;
            const reason = document.getElementById('watch-reason').value;

            if (!accountId) {
                alert('Please enter an account ID');
                return;
            }

            try {
                await fetch(API_BASE + `/api/watch/${accountId}?platform=${platform}&reason=${encodeURIComponent(reason)}`, { method: 'POST' });
                closeWatchModal();
                loadWatched();
            } catch (e) {
                alert('Failed to add account');
            }
        }

        // Utility functions
        function truncateId(id, len = 12) {
            if (id.length <= len) return id;
            return id.slice(0, len) + '...';
        }

        function getScoreClass(score) {
            if (score >= 0.7) return 'score-high';
            if (score >= 0.4) return 'score-medium';
            return 'score-low';
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = (now - date) / 1000;

            if (diff < 60) return 'just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            return Math.floor(diff / 86400) + 'd ago';
        }

        function formatDate(isoString) {
            return new Date(isoString).toLocaleDateString();
        }
    </script>
</body>
</html>
